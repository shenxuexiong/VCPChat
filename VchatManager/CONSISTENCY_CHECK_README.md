# 数据一致性检查功能

## 功能概述

数据一致性检查功能用于检测和修复聊天历史文件夹与 Agent 配置文件中话题列表之间的不一致问题。

## 主要特性

### 1. 一致性检查
- 检测配置文件中存在但文件系统中缺失的话题（missing_files）
- 检测文件系统中存在但配置文件中缺失的话题（orphaned_files）
- 检测完全缺失话题目录的情况（missing_all_files）

### 2. 安全修复
- **只修改 topics 数组**：修复操作仅针对 config.json 中的 `topics` 字段，不会影响其他配置项
- **可选修复选项**：
  - 添加孤立话题：将文件系统中存在但配置中缺失的话题添加到配置
  - 移除缺失话题：从配置中移除文件系统中不存在的话题
- **选择性修复**：可以选择要修复的具体问题

### 3. 详细报告
- 显示每个问题的详细信息
- 对于孤立话题，显示消息数量
- 修复后显示操作结果

## 使用方法

### 打开一致性检查
1. 点击侧边栏顶部的 "🔍 Check Consistency" 按钮
2. 或使用快捷键（待实现）

### 执行检查
1. 在弹出的对话框中点击 "Run Check" 按钮
2. 等待扫描完成
3. 查看检查结果

### 修复问题
1. 查看发现的问题列表
2. 取消勾选不想修复的问题
3. 选择修复选项：
   - ✓ 添加孤立话题（推荐）
   - ✓ 移除缺失话题（谨慎使用）
4. 点击 "Apply Fixes" 按钮
5. 确认修复操作
6. 查看修复结果

## 问题类型说明

### orphaned_files（孤立文件）
**现象**：文件系统中存在话题文件夹，但 config.json 中没有对应记录

**原因**：
- 手动删除了配置文件中的话题记录
- 配置文件损坏或回滚
- 程序异常导致配置未更新

**建议**：选择"添加孤立话题"将其恢复到配置中

### missing_files（缺失文件）
**现象**：config.json 中有话题记录，但文件系统中没有对应文件夹

**原因**：
- 手动删除了话题文件夹
- 文件系统损坏
- 文件被移动或重命名

**建议**：
- 如果确认文件已永久丢失，选择"移除缺失话题"清理配置
- 如果文件可能被移动，先手动恢复文件再运行检查

### missing_all_files（完全缺失）
**现象**：配置中有话题列表，但整个 topics 目录都不存在

**原因**：
- UserData 目录被删除或损坏
- 首次创建 Agent 但未创建任何话题

**建议**：检查 UserData 目录是否存在，必要时手动创建

## 安全性保证

1. **只读检查**：检查操作不会修改任何文件
2. **精确修改**：修复操作只修改 `topics` 数组，保留所有其他配置
3. **确认机制**：修复前需要用户确认
4. **备份建议**：重要数据建议在修复前手动备份

## 技术实现

### 核心模块
- `consistency-checker.js`：一致性检查核心逻辑
- `script.js`：UI 集成和用户交互
- `style.css`：样式定义

### 关键方法
```javascript
// 执行检查
await consistencyChecker.performCheck(agents, groups)

// 应用修复
await consistencyChecker.fixIssues(selectedIssues, {
    addOrphaned: true,
    removeMissing: false
})
```

### 配置文件安全读写
```javascript
// 读取配置
const config = JSON.parse(configStr);

// 只修改 topics
config.topics = updatedTopics;

// 写回文件
await window.api.writeFile(configPath, JSON.stringify(config, null, 2));
```

## 注意事项

1. **修复前备份**：对于重要数据，建议先备份整个 AppData 目录
2. **谨慎删除**：使用"移除缺失话题"选项前，确认文件确实无法恢复
3. **批量操作**：可以一次性修复多个 Agent/Group 的问题
4. **重新加载**：修复后会自动重新加载数据，侧边栏会更新

## 未来改进

- [ ] 添加键盘快捷键
- [ ] 支持导出检查报告
- [ ] 添加自动备份功能
- [ ] 支持预览修复效果
- [ ] 添加撤销功能
- [ ] 支持批量备份和恢复

## 故障排除

### 检查失败
- 确认 AppData 目录存在且可访问
- 检查文件权限
- 查看控制台错误信息

### 修复失败
- 确认配置文件不是只读
- 检查磁盘空间
- 确认 JSON 格式正确

### 数据丢失
- 立即停止操作
- 从备份恢复
- 联系技术支持