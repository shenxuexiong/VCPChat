<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VCP ÁÅµËßÜ‰∏≠ÂøÉ | Ether Observer</title>
    <link rel="stylesheet" href="../styles/themes.css">
    <style>
        :root {
            --card-enter-duration: 0.6s;
            --ease-elastic: cubic-bezier(0.68, -0.55, 0.27, 1.55); /* Êõ¥QÂºπÁöÑÊûúÂÜªÊïàÊûú */
            --glass-border: 1px solid rgba(255, 255, 255, 0.1);
            --glass-bg: rgba(20, 20, 20, 0.6);
            --glass-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            --accent-rag: #3498db;
            --accent-chain: #9b59b6;
            --accent-agent: #f1c40f;
            --accent-memo: #1abc9c;
        }

        body {
            font-family: 'JetBrains Mono', 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif;
            color: var(--primary-text);
            margin: 0;
            background-color: var(--panel-bg, #0f0f12); /* Ê∑±Á©∫Â∫ïËâ≤ */
            display: flex;
            justify-content: center;
            height: 100vh;
            overflow: hidden;
            transition: background-color 0.3s ease;
        }

        /* --- Custom Title Bar --- */
        #custom-title-bar {
            position: fixed;
            top: 0; left: 0; right: 0;
            height: 38px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 16px;
            background: linear-gradient(to bottom, rgba(0,0,0,0.8), rgba(0,0,0,0));
            z-index: 2000;
            -webkit-app-region: drag;
            backdrop-filter: blur(4px);
        }

        #custom-title-bar .title {
            font-size: 12px;
            font-weight: 600;
            letter-spacing: 1px;
            text-transform: uppercase;
            opacity: 0.6;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .window-controls {
            display: flex;
            gap: 8px;
            -webkit-app-region: no-drag;
        }

        .window-control-btn {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: none;
            padding: 0;
            cursor: pointer;
            transition: transform 0.2s, opacity 0.2s;
            opacity: 0.8;
        }
        .window-control-btn:hover { transform: scale(1.2); opacity: 1; }
        #mac-close-btn { background: #ff5f56; }
        #mac-minimize-btn { background: #ffbd2e; }
        #mac-maximize-btn { background: #27c93f; }

        /* --- Windows Controls --- */
        .window-controls-win {
            display: none;
            -webkit-app-region: no-drag;
        }
        .win-control-btn {
            width: 40px;
            height: 38px;
            background: transparent;
            border: none;
            color: rgba(255,255,255,0.7);
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .win-control-btn:hover { background: rgba(255,255,255,0.1); color: #fff; }
        #win-close-btn:hover { background: #e81123; color: #fff; }
        .win-control-btn svg { width: 12px; height: 12px; }

        /* --- Platform Specific Layout --- */
        .window-controls-mac, .window-controls-win { display: none; }
        .platform-mac .window-controls-mac { display: flex; }
        .platform-win .window-controls-win { display: flex; }

        /* Mac: [controls] [title] [spacer] */
        .platform-mac #custom-title-bar { justify-content: space-between; }
        .platform-mac #custom-title-bar::after { content: ''; width: 64px; }

        /* Win: [title] [controls] */
        .platform-win #custom-title-bar { justify-content: flex-start; }
        .platform-win .title { flex-grow: 1; }

        /* --- Main Container --- */
        .main-wrapper {
            width: 100%;
            max-width: 1000px;
            height: 100%;
            display: flex;
            flex-direction: column;
            padding-top: 40px;
            box-sizing: border-box;
        }

        .header-section {
            padding: 10px 20px;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 100;
        }

        /* --- Visualizer Canvas --- */
        #spectrum-canvas {
            width: 100%;
            height: 4px;
            position: absolute;
            top: 38px;
            left: 0;
            z-index: 1500;
            opacity: 0.8;
            pointer-events: none;
        }

        /* --- Filter Bar (The Cool Part) --- */
        .filter-bar {
            display: flex;
            position: relative; /* For highlight positioning */
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            padding: 4px;
            margin-bottom: 15px;
            border: var(--glass-border);
            backdrop-filter: blur(10px);
        }

        .filter-highlight {
            position: absolute;
            top: 4px;
            left: 0;
            height: calc(100% - 8px);
            border-radius: 16px;
            background: rgba(255, 255, 255, 0.15);
            transition: all 0.4s var(--ease-elastic); /* ÈÄüÂ∫¶Âä†Âø´ */
            z-index: 0;
            backdrop-filter: blur(4px); /* Á£®Á†ÇÊïàÊûú */
        }

        .filter-btn {
            background: transparent;
            border: none;
            color: var(--secondary-text);
            padding: 6px 16px;
            border-radius: 16px;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: color 0.3s ease;
            position: relative;
            z-index: 1;
        }

        .filter-btn.active {
            color: white;
        }
        
        .filter-btn:hover:not(.active) { color: var(--primary-text); }

        /* --- Scrollable Content --- */
        #infoContainer {
            flex: 1;
            overflow-y: overlay; /* Elegant scroll */
            padding: 0 20px 20px 20px;
            scroll-behavior: smooth;
        }

        /* Custom Scrollbar */
        #infoContainer::-webkit-scrollbar { width: 6px; }
        #infoContainer::-webkit-scrollbar-track { background: transparent; }
        #infoContainer::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }
        #infoContainer::-webkit-scrollbar-thumb:hover { background: rgba(255, 255, 255, 0.2); }

        /* --- Card Base Styles --- */
        .card-base {
            background: var(--glass-bg);
            backdrop-filter: blur(16px) saturate(180%);
            border: var(--glass-border);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 24px;
            position: relative;
            overflow: hidden;
            transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1), box-shadow 0.3s ease, opacity 0.4s ease;
            /* Initial state for animation */
            opacity: 0;
            transform: translateY(30px) scale(0.98);
        }

        .card-base:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(0,0,0,0.4);
            border-color: rgba(255,255,255,0.2);
        }

        /* Dynamic border accent line */
        .card-base::before {
            content: '';
            position: absolute;
            top: 0; left: 0; bottom: 0;
            width: 3px;
            background: var(--accent-color, #fff);
            opacity: 0.7;
        }

        /* Animation Class */
        .card-enter {
            animation: cardEnter var(--card-enter-duration) var(--ease-elastic) forwards;
        }

        @keyframes cardEnter {
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        /* --- Typography & Details --- */
        h3 {
            margin: 0 0 10px 0;
            font-size: 1.1rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
            color: #fff;
        }

        .meta-info {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.5);
            margin-bottom: 12px;
            font-family: 'JetBrains Mono', monospace;
        }

        .meta-pill {
            background: rgba(255,255,255,0.05);
            padding: 2px 8px;
            border-radius: 6px;
            border: 1px solid rgba(255,255,255,0.05);
        }

        /* --- Content & Collapsible --- */
        .content-wrapper {
            position: relative;
        }
        
        .text-content {
            font-size: 0.95rem;
            line-height: 1.6;
            color: rgba(255, 255, 255, 0.9);
            word-break: break-word;
            position: relative;
        }

        .text-content code {
            background: rgba(0,0,0,0.3);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9em;
            color: #e06c75;
        }

        .snippet {
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
            mask-image: linear-gradient(180deg, #000 60%, transparent);
        }
        
        .full-text {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* --- Action Buttons --- */
        .action-row {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 8px;
        }

        .icon-btn {
            background: rgba(255,255,255,0.05);
            border: none;
            color: rgba(255,255,255,0.6);
            cursor: pointer;
            padding: 6px;
            border-radius: 6px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .icon-btn:hover {
            background: rgba(255,255,255,0.15);
            color: #fff;
        }

        .icon-btn svg { width: 16px; height: 16px; }

        .toggle-arrow {
            transition: transform 0.3s var(--ease-elastic);
        }
        .expanded .toggle-arrow { transform: rotate(180deg); }

        /* --- Specific Card Types --- */
        .type-rag { --accent-color: var(--accent-rag); }
        .type-chain { --accent-color: var(--accent-chain); }
        .type-chat { --accent-color: var(--accent-agent); }
        .type-memo { --accent-color: var(--accent-memo); }

        /* RAG Item */
        .rag-sub-item {
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
            padding: 12px;
            margin-top: 10px;
            border: 1px solid rgba(255,255,255,0.05);
        }

        .score-badge {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: bold;
        }
        .score-high { color: #4caf50; background: rgba(76, 175, 80, 0.1); border: 1px solid rgba(76, 175, 80, 0.3); }
        .score-med { color: #ff9800; background: rgba(255, 152, 0, 0.1); border: 1px solid rgba(255, 152, 0, 0.3); }
        .score-low { color: #f44336; background: rgba(244, 67, 54, 0.1); border: 1px solid rgba(244, 67, 54, 0.3); }
        .score-boosted { 
            background: linear-gradient(45deg, rgba(255,193,7,0.1), rgba(255,152,0,0.2)); 
            color: #ffc107; 
            border: 1px solid #ffc107;
            box-shadow: 0 0 8px rgba(255, 193, 7, 0.2);
        }

        /* Clear Animation */
        .card-base.is-clearing {
            opacity: 0;
            transform: translateY(30px) scale(0.95);
        }

        /* Status Indicator */
        .status-pill {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 12px;
            background: rgba(0,0,0,0.3);
            border-radius: 12px;
            font-size: 0.75rem;
            color: rgba(255,255,255,0.6);
            border: 1px solid rgba(255,255,255,0.05);
            margin-bottom: 10px;
        }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; }
        .dot-green { background: #4caf50; box-shadow: 0 0 8px #4caf50; animation: pulse 2s infinite; }
        .dot-red { background: #f44336; }
        .dot-orange { background: #ff9800; }

        @keyframes pulse { 0% { opacity: 0.5; transform: scale(0.9); } 50% { opacity: 1; transform: scale(1.1); } 100% { opacity: 0.5; transform: scale(0.9); } }

    </style>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>marked.setOptions({ gfm: true, breaks: true });</script>
    <script src="./rag-observer-config.js"></script>
</head>
<body>
    <!-- Title Bar -->
    <div id="custom-title-bar">
        <div class="window-controls window-controls-mac">
            <button id="mac-close-btn" class="window-control-btn" title="ÂÖ≥Èó≠"></button>
            <button id="mac-minimize-btn" class="window-control-btn" title="ÊúÄÂ∞èÂåñ"></button>
            <button id="mac-maximize-btn" class="window-control-btn" title="ÊúÄÂ§ßÂåñ"></button>
        </div>
        <div class="title">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="4"></circle></svg>
            VCP ‰ø°ÊÅØÊµÅÁõëÂê¨Âô®
        </div>
        <div class="window-controls window-controls-win">
            <button id="win-minimize-btn" class="win-control-btn" title="ÊúÄÂ∞èÂåñ"><svg><use href="#icon-win-minimize"></use></svg></button>
            <button id="win-maximize-btn" class="win-control-btn" title="ÊúÄÂ§ßÂåñ"><svg><use href="#icon-win-maximize"></use></svg></button>
            <button id="win-close-btn" class="win-control-btn" title="ÂÖ≥Èó≠"><svg><use href="#icon-win-close"></use></svg></button>
        </div>
    </div>

    <canvas id="spectrum-canvas"></canvas>

    <div class="main-wrapper">
        <div class="header-section">
            <div id="connectionStatus" class="status-pill">
                <div class="status-dot dot-red" id="statusDot"></div>
                <span id="statusText">Êú™ËøûÊé•</span>
            </div>

            <div class="filter-bar">
                <div class="filter-highlight"></div>
                <button class="filter-btn active" data-type="all" onclick="filterLogs('all', this)">ÂÖ®ÈÉ®</button>
                <button class="filter-btn" data-type="rag" onclick="filterLogs('rag', this)">RAGÁü•ËØÜÂ∫ì</button>
                <button class="filter-btn" data-type="chain" onclick="filterLogs('chain', this)">ÂÖÉÊÄùËÄÉÈìæ</button>
                <button class="filter-btn" data-type="chat" onclick="filterLogs('chat', this)">Agent‰ºöËØù</button>
                <button class="filter-btn" data-type="memo" onclick="filterLogs('memo', this)">ËÆ∞ÂøÜÊ£ÄÁ¥¢</button>
                <button class="filter-btn" onclick="clearLogs()" style="margin-left: 10px; color: #ff5f56;">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                </button>
            </div>
        </div>

        <div id="infoContainer">
            <div style="text-align:center; color:rgba(255,255,255,0.3); margin-top: 50px; font-size: 0.9rem;">
                <p>Á≠âÂæÖÊï∞ÊçÆÊé•ÂÖ•...</p>
                <p style="font-size: 0.8em;">System Ready</p>
            </div>
        </div>
    </div>

    <!-- Icons Def -->
    <svg style="display: none;">
        <symbol id="icon-copy" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></symbol>
        <symbol id="icon-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></symbol>
        <symbol id="icon-check" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"></polyline></symbol>
        <symbol id="icon-win-minimize" viewBox="0 0 10 10"><path stroke="currentColor" stroke-width="1.2" d="M0 5 H10"></path></symbol>
        <symbol id="icon-win-maximize" viewBox="0 0 10 10"><path fill="none" stroke="currentColor" stroke-width="1.2" d="M1,1 h8 v8 h-8 z"></path></symbol>
        <symbol id="icon-win-close" viewBox="0 0 10 10"><path stroke="currentColor" stroke-width="1.2" d="M1,1 L9,9 M9,1 L1,9"></path></symbol>
    </svg>

    <script>
        // --- Visuals & Utils ---
        const infoContainer = document.getElementById('infoContainer');
        let currentFilter = 'all';

        function updateStatus(status, message) {
            const dot = document.getElementById('statusDot');
            const text = document.getElementById('statusText');
            
            dot.className = 'status-dot';
            if (status === 'open') dot.classList.add('dot-green');
            else if (status === 'connecting') dot.classList.add('dot-orange');
            else dot.classList.add('dot-red');
            
            text.textContent = message;
        }

        function filterLogs(type, btnElement) {
            if (!btnElement) return;
            currentFilter = type;
            
            // Update buttons
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            btnElement.classList.add('active');

            // Move the highlight
            const highlight = document.querySelector('.filter-highlight');
            highlight.style.width = `${btnElement.offsetWidth}px`;
            highlight.style.transform = `translateX(${btnElement.offsetLeft}px)`;

            // Change highlight color based on type
            const typeColors = {
                'all': 'rgba(255, 255, 255, 0.15)',
                'rag': 'rgba(52, 152, 219, 0.4)', // --accent-rag
                'chain': 'rgba(155, 89, 182, 0.4)', // --accent-chain
                'chat': 'rgba(241, 196, 15, 0.4)', // --accent-agent
                'memo': 'rgba(26, 188, 156, 0.4)' // --accent-memo
            };
            highlight.style.backgroundColor = typeColors[type] || typeColors['all'];

            // Filter DOM
            const cards = document.querySelectorAll('.card-base');
            cards.forEach(card => {
                if (type === 'all') {
                    card.style.display = 'block';
                } else {
                    if (card.classList.contains(`type-${type}`)) {
                        card.style.display = 'block';
                    } else {
                        card.style.display = 'none';
                    }
                }
            });
        }

        function clearLogs() {
            const cards = infoContainer.querySelectorAll('.card-base');
            if (cards.length === 0) return;

            cards.forEach((card, index) => {
                // FINAL FIX: Forcefully remove the animation lock before triggering the transition.
                card.classList.remove('card-enter');
                card.style.animation = 'none'; // Explicitly clear the animation property.
                void card.offsetHeight; // Force a browser reflow to apply the style changes.

                // Stagger the application of the clearing class to trigger the transition.
                setTimeout(() => {
                    card.classList.add('is-clearing');
                }, index * 50);
            });

            // Use the longest transition duration from the .card-base rule (opacity is 0.4s)
            const animationDuration = 400;
            const lastCardDelay = (cards.length - 1) * 50;

            setTimeout(() => {
                infoContainer.innerHTML = `
                    <div style="text-align:center; color:rgba(255,255,255,0.3); margin-top: 50px; font-size: 0.9rem;">
                        <p>Á≠âÂæÖÊï∞ÊçÆÊé•ÂÖ•...</p>
                        <p style="font-size: 0.8em;">System Ready</p>
                    </div>`;
            }, lastCardDelay + animationDuration);
        }

        function copyToClipboard(text, btn) {
            navigator.clipboard.writeText(text).then(() => {
                const originalHTML = btn.innerHTML;
                btn.innerHTML = `<svg class="icon-btn-svg"><use href="#icon-check"></use></svg>`;
                btn.style.color = '#4caf50';
                setTimeout(() => {
                    btn.innerHTML = originalHTML;
                    btn.style.color = '';
                }, 1500);
            });
        }

        function toggleExpand(btn) {
            const wrapper = btn.closest('.content-wrapper');
            if (!wrapper) return;
            
            const snippet = wrapper.querySelector('.snippet');
            const full = wrapper.querySelector('.full-text');
            const arrow = btn.querySelector('.toggle-arrow');
            
            // Toggle logic
            if (full.style.display === 'block') {
                full.style.display = 'none';
                snippet.style.display = '-webkit-box'; // Restore line clamp
                btn.classList.remove('expanded');
            } else {
                full.style.display = 'block';
                snippet.style.display = 'none';
                btn.classList.add('expanded');
            }
        }

        // --- Block Generators ---

        // Helper to create generic toggle-able text
        function createContentHTML(text) {
            if (!text) return '';
            const isLong = text.length > 150;
            const rendered = marked.parse(text);
            
            if (!isLong) return `<div class="text-content">${rendered}</div>`;

            // Safe string escaping for onclick
            const escapedText = text.replace(/"/g, '&quot;').replace(/'/g, "\\'");
            
            return `
                <div class="content-wrapper">
                    <div class="text-content">
                        <div class="snippet">${text}</div>
                        <div class="full-text">${rendered}</div>
                    </div>
                    <div class="action-row">
                        <button class="icon-btn" title="Â§çÂà∂" onclick="copyToClipboard(decodeURIComponent('${encodeURIComponent(text)}'), this)">
                            <svg><use href="#icon-copy"></use></svg>
                        </button>
                        <button class="icon-btn" title="Â±ïÂºÄ/Êî∂Ëµ∑" onclick="toggleExpand(this)">
                            <svg class="toggle-arrow"><use href="#icon-chevron"></use></svg>
                        </button>
                    </div>
                </div>
            `;
        }

        // 1. RAG BLOCK
        function displayRagInfo(data) {
            // Handle specialized types first
            if (data.type === 'AGENT_PRIVATE_CHAT_PREVIEW') return displayAgentChat(data);
            if (data.type === 'META_THINKING_CHAIN') return displayChain(data);
            if (data.type === 'AI_MEMO_RETRIEVAL') return displayMemo(data);

            const block = document.createElement('div');
            block.className = 'card-base type-rag card-enter';
            
            // Header
            let headerHTML = `
                <h3>
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg>
                    ${data.dbName}
                </h3>
                <div class="meta-info">
                    <span class="meta-pill">K: ${data.k}</span>
                    <span class="meta-pill">Time: ${data.useTime}</span>
                    <span class="meta-pill">ReRank: ${data.useRerank}</span>
                    ${data.useTagMemo ? `<span class="meta-pill" style="color:#ffc107; border-color:#ffc107;">TagBoost: ${data.tagWeight}</span>` : ''}
                </div>
                ${createContentHTML(data.query)}
            `;
            
            // Results
            let resultsHTML = '';
            data.results.forEach(r => {
                // BUG FIX: Check if r.score is a valid number before calling toFixed().
                // Time-based results from the backend don't have a score, which was causing a rendering crash.
                const hasScore = typeof r.score === 'number';
                const scoreDisplay = hasScore ? r.score.toFixed(3) : 'Time'; // Display 'Time' for time-based results
                const scoreClass = hasScore ? (r.score >= 0.8 ? 'score-high' : (r.score >= 0.5 ? 'score-med' : 'score-low')) : 'score-med';
                const isBoosted = data.useTagMemo && r.originalScore && r.originalScore !== r.score;
                
                let tagsHTML = '';
                if(r.matchedTags && r.matchedTags.length) {
                    tagsHTML = `<div style="margin-top:4px; font-size:0.75em; color:#ffc107;">üè∑Ô∏è ${r.matchedTags.join(', ')}</div>`;
                }

                resultsHTML += `
                    <div class="rag-sub-item">
                        <div style="display:flex; justify-content:space-between; margin-bottom:6px;">
                            <span class="score-badge ${isBoosted ? 'score-boosted' : scoreClass}">
                                ${scoreDisplay} ${isBoosted ? '‚ö°' : ''}
                            </span>
                            <span style="font-size:0.75em; opacity:0.6;">${r.source || 'Unknown'}</span>
                        </div>
                        ${createContentHTML(r.text)}
                        ${tagsHTML}
                    </div>
                `;
            });

            block.innerHTML = headerHTML + `<div style="margin-top:15px;">${resultsHTML}</div>`;
            prependCard(block);
        }

        // 2. CHAIN BLOCK
        function displayChain(data) {
            const block = document.createElement('div');
            block.className = 'card-base type-chain card-enter';

            // Chain Path Visualization
            const stagesPath = data.stages.map(s => s.clusterName).join(' <span style="opacity:0.4;">‚Üí</span> ');

            let headerHTML = `
                <h3 style="color: var(--accent-chain);">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="18" cy="5" r="3"></circle><circle cx="6" cy="12" r="3"></circle><circle cx="18" cy="19" r="3"></circle><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line></svg>
                    ÂÖÉÊÄùËÄÉÈìæ: ${data.chainName}
                </h3>
                <div class="meta-info" style="color:var(--accent-chain); font-weight:600;">
                    ${stagesPath}
                </div>
                ${createContentHTML(data.query)}
            `;

            let stagesHTML = '';
            if (data.stages && data.stages.length > 0) {
                data.stages.forEach(stage => {
                    let resultsHTML = '';
                    if (stage.results && stage.results.length > 0) {
                        stage.results.forEach(r => {
                            resultsHTML += `
                                <div class="rag-sub-item" style="background:rgba(0,0,0,0.1); margin-top:8px;">
                                     <div style="display:flex; justify-content:space-between; margin-bottom:6px;">
                                        <span class="score-badge score-med">
                                            Score: ${r.score ? r.score.toFixed(3) : 'N/A'}
                                        </span>
                                        <span style="font-size:0.75em; opacity:0.6;">${r.source || 'Unknown'}</span>
                                    </div>
                                    ${createContentHTML(r.text)}
                                </div>
                            `;
                        });
                    } else {
                        resultsHTML = `<div class="rag-sub-item" style="background:rgba(0,0,0,0.1); margin-top:8px; font-style:italic; color:rgba(255,255,255,0.5);">Êú¨Èò∂ÊÆµÊó†ÁªìÊûú</div>`;
                    }

                    stagesHTML += `
                        <div class="rag-sub-item" style="margin-top:15px; border-left: 2px solid var(--accent-chain);">
                            <div style="font-weight:bold; color: #fff; margin-bottom: 8px;">
                                Èò∂ÊÆµ ${stage.stage}: ${stage.clusterName} (${stage.resultCount}‰∏™ÁªìÊûú)
                            </div>
                            ${resultsHTML}
                        </div>
                    `;
                });
            }

            block.innerHTML = headerHTML + `<div style="margin-top:15px;">${stagesHTML}</div>`;
            prependCard(block);
        }

        // 3. AGENT CHAT BLOCK
        function displayAgentChat(data) {
            const block = document.createElement('div');
            block.className = 'card-base type-chat card-enter';
            block.innerHTML = `
                <h3 style="color: var(--accent-agent);">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
                    Agent ÁßÅËÅä: ${data.agentName}
                </h3>
                <div style="margin-top:10px; padding-left:10px; border-left:2px solid rgba(255,255,255,0.1);">
                    <div style="font-size:0.8em; opacity:0.5; margin-bottom:4px;">USER</div>
                    ${createContentHTML(data.query)}
                </div>
                <div style="margin-top:15px; padding-left:10px; border-left:2px solid var(--accent-agent);">
                    <div style="font-size:0.8em; color:var(--accent-agent); margin-bottom:4px;">AI RESPONSE</div>
                    ${createContentHTML(data.response)}
                </div>
            `;
            prependCard(block);
        }

        // 4. MEMO BLOCK
        function displayMemo(data) {
            const block = document.createElement('div');
            block.className = 'card-base type-memo card-enter';
            block.innerHTML = `
                <h3 style="color: var(--accent-memo);">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                    ËÆ∞ÂøÜÂõûÊ∫Ø (${data.diaryCount || 0})
                </h3>
                <div class="meta-info">Ê®°Âºè: ${data.mode}</div>
                ${createContentHTML(data.extractedMemories)}
            `;
            prependCard(block);
        }

        function prependCard(element) {
            // Check filter before adding
            const type = element.classList.contains('type-rag') ? 'rag' :
                         element.classList.contains('type-chain') ? 'chain' :
                         element.classList.contains('type-chat') ? 'chat' :
                         element.classList.contains('type-memo') ? 'memo' : 'all';
            
            if (currentFilter !== 'all' && currentFilter !== type) {
                element.style.display = 'none';
            }

            // Remove "Waiting..." text if present
            if (infoContainer.children.length > 0 && infoContainer.children[0].tagName === 'DIV' && infoContainer.children[0].innerText.includes('Á≠âÂæÖÊï∞ÊçÆ')) {
                infoContainer.innerHTML = '';
            }

            infoContainer.prepend(element);
        }

        // --- Spectrum Animation ---
        const canvas = document.getElementById('spectrum-canvas');
        const ctx = canvas.getContext('2d');
        let animationId;

        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = 4; // Thin line
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        window.startSpectrumAnimation = function(duration = 3000) {
            if (animationId) cancelAnimationFrame(animationId);
            let startTime = Date.now();

            function draw() {
                const elapsed = Date.now() - startTime;
                if (elapsed > duration) {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    return;
                }

                ctx.clearRect(0, 0, canvas.width, canvas.height);
                const gradient = ctx.createLinearGradient(0, 0, canvas.width, 0);
                gradient.addColorStop(0, '#3498db');
                gradient.addColorStop(0.5, '#9b59b6');
                gradient.addColorStop(1, '#f1c40f');
                ctx.fillStyle = gradient;

                // Simple wave effect
                const width = canvas.width;
                const bars = 50;
                const step = width / bars;
                
                for(let i=0; i<bars; i++) {
                    const t = Date.now() * 0.005;
                    const h = (Math.sin(i * 0.2 + t) + 1) * 2; // Height variation
                    ctx.fillRect(i * step, 2 - h/2, step-2, h);
                }

                animationId = requestAnimationFrame(draw);
            }
            draw();
        }

        // --- UI Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            const activeButton = document.querySelector('.filter-btn.active');
            if (activeButton) {
                setTimeout(() => {
                    const highlight = document.querySelector('.filter-highlight');
                    if (!highlight) return;
                    
                    highlight.style.transition = 'none'; // No animation on load
                    highlight.style.width = `${activeButton.offsetWidth}px`;
                    highlight.style.transform = `translateX(${activeButton.offsetLeft}px)`;
                    
                    // Force reflow to apply styles immediately
                    void highlight.offsetWidth;
                    
                    // Re-enable transitions
                    highlight.style.transition = 'all 0.4s var(--ease-elastic)';
                }, 100); // A small delay to ensure layout is calculated
            }
        });
    </script>
</body>
</html>